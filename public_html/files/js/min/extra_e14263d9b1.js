;(function($){jQuery.event.props.push("dataTransfer");var default_opts={fallback_id:'',url:'',refresh:1000,paramname:'userfile',allowedfiletypes:[],maxfiles:25,maxfilesize:1,queuefiles:0,queuewait:200,data:{},headers:{},drop:empty,dragStart:empty,dragEnter:empty,dragOver:empty,dragLeave:empty,docEnter:empty,docOver:empty,docLeave:empty,beforeEach:empty,afterAll:empty,rename:empty,error:function(err,file,i,status){alert(err);},uploadStarted:empty,uploadFinished:empty,progressUpdated:empty,globalProgressUpdated:empty,speedUpdated:empty},errors=["BrowserNotSupported","TooManyFiles","FileTooLarge","FileTypeNotAllowed","NotFound","NotReadable","AbortError","ReadError"],doc_leave_timer,stop_loop=false,files_count=0,files;$.fn.filedrop=function(options){var opts=$.extend({},default_opts,options),global_progress=[];this.on('drop',drop).on('dragstart',opts.dragStart).on('dragenter',dragEnter).on('dragover',dragOver).on('dragleave',dragLeave);$(document).on('drop',docDrop).on('dragenter',docEnter).on('dragover',docOver).on('dragleave',docLeave);$('#'+opts.fallback_id).change(function(e){opts.drop(e);files=e.target.files;files_count=files.length;upload();});function drop(e){if(opts.drop.call(this,e)===false)return false;files=e.dataTransfer.files;if(files===null||files===undefined||files.length===0){opts.error(errors[0]);return false;}
files_count=files.length;upload();e.preventDefault();return false;}
function getBuilder(filename,filedata,mime,boundary){var dashdash='--',crlf='\r\n',builder='';if(opts.data){var params=$.param(opts.data).replace(/\+/g,'%20').split(/&/);$.each(params,function(){var pair=this.split("=",2),name=decodeURIComponent(pair[0]),val=decodeURIComponent(pair[1]);builder+=dashdash;builder+=boundary;builder+=crlf;builder+='Content-Disposition: form-data; name="'+name+'"';builder+=crlf;builder+=crlf;builder+=val;builder+=crlf;});}
builder+=dashdash;builder+=boundary;builder+=crlf;builder+='Content-Disposition: form-data; name="'+opts.paramname+'"';builder+='; filename="'+filename+'"';builder+=crlf;builder+='Content-Type: '+mime;builder+=crlf;builder+=crlf;builder+=filedata;builder+=crlf;builder+=dashdash;builder+=boundary;builder+=dashdash;builder+=crlf;return builder;}
function progress(e){if(e.lengthComputable){var percentage=Math.round((e.loaded*100)/e.total);if(this.currentProgress!==percentage){this.currentProgress=percentage;opts.progressUpdated(this.index,this.file,this.currentProgress);global_progress[this.global_progress_index]=this.currentProgress;globalProgress();var elapsed=new Date().getTime();var diffTime=elapsed-this.currentStart;if(diffTime>=opts.refresh){var diffData=e.loaded-this.startData;var speed=diffData/diffTime;opts.speedUpdated(this.index,this.file,speed);this.startData=e.loaded;this.currentStart=elapsed;}}}}
function globalProgress(){if(global_progress.length===0){return;}
var total=0,index;for(index in global_progress){if(global_progress.hasOwnProperty(index)){total=total+global_progress[index];}}
opts.globalProgressUpdated(Math.round(total/global_progress.length));}
function upload(){stop_loop=false;if(!files){opts.error(errors[0]);return false;}
if(opts.allowedfiletypes.push&&opts.allowedfiletypes.length){for(var fileIndex=files.length;fileIndex--;){if(!files[fileIndex].type||$.inArray(files[fileIndex].type,opts.allowedfiletypes)<0){opts.error(errors[3],files[fileIndex]);return false;}}}
var filesDone=0,filesRejected=0;if(files_count>opts.maxfiles&&opts.queuefiles===0){opts.error(errors[1]);return false;}
var workQueue=[];var processingQueue=[];var doneQueue=[];for(var i=0;i<files_count;i++){workQueue.push(i);}
var pause=function(timeout){setTimeout(process,timeout);return;};var process=function(){var fileIndex;if(stop_loop){return false;}
if(opts.queuefiles>0&&processingQueue.length>=opts.queuefiles){return pause(opts.queuewait);}else{fileIndex=workQueue[0];workQueue.splice(0,1);processingQueue.push(fileIndex);}
try{if(beforeEach(files[fileIndex])!==false){if(fileIndex===files_count){return;}
var reader=new FileReader(),max_file_size=1048576*opts.maxfilesize;reader.index=fileIndex;if(files[fileIndex].size>max_file_size){opts.error(errors[2],files[fileIndex],fileIndex);processingQueue.forEach(function(value,key){if(value===fileIndex){processingQueue.splice(key,1);}});filesRejected++;return true;}
reader.onerror=function(e){switch(e.target.error.code){case e.target.error.NOT_FOUND_ERR:opts.error(errors[4]);return false;case e.target.error.NOT_READABLE_ERR:opts.error(errors[5]);return false;case e.target.error.ABORT_ERR:opts.error(errors[6]);return false;default:opts.error(errors[7]);return false;};};reader.onloadend=!opts.beforeSend?send:function(e){opts.beforeSend(files[fileIndex],fileIndex,function(){send(e);});};reader.readAsBinaryString(files[fileIndex]);}else{filesRejected++;}}catch(err){processingQueue.forEach(function(value,key){if(value===fileIndex){processingQueue.splice(key,1);}});opts.error(errors[0]);return false;}
if(workQueue.length>0){process();}};var send=function(e){var fileIndex=((typeof(e.srcElement)==="undefined")?e.target:e.srcElement).index;if(e.target.index===undefined){e.target.index=getIndexBySize(e.total);}
var xhr=new XMLHttpRequest(),upload=xhr.upload,file=files[e.target.index],index=e.target.index,start_time=new Date().getTime(),boundary='------multipartformboundary'+(new Date()).getTime(),global_progress_index=global_progress.length,builder,newName=rename(file.name),mime=file.type;if(opts.withCredentials){xhr.withCredentials=opts.withCredentials;}
if(typeof newName==="string"){builder=getBuilder(newName,e.target.result,mime,boundary);}else{builder=getBuilder(file.name,e.target.result,mime,boundary);}
upload.index=index;upload.file=file;upload.downloadStartTime=start_time;upload.currentStart=start_time;upload.currentProgress=0;upload.global_progress_index=global_progress_index;upload.startData=0;upload.addEventListener("progress",progress,false);if(jQuery.isFunction(opts.url)){xhr.open("POST",opts.url(),true);}else{xhr.open("POST",opts.url,true);}
xhr.setRequestHeader('content-type','multipart/form-data; boundary='+boundary);$.each(opts.headers,function(k,v){xhr.setRequestHeader(k,v);});xhr.sendAsBinary(builder);global_progress[global_progress_index]=0;globalProgress();opts.uploadStarted(index,file,files_count);xhr.onload=function(){var serverResponse=null;if(xhr.responseText){try{serverResponse=jQuery.parseJSON(xhr.responseText);}
catch(e){serverResponse=xhr.responseText;}}
var now=new Date().getTime(),timeDiff=now-start_time,result=opts.uploadFinished(index,file,serverResponse,timeDiff,xhr);filesDone++;processingQueue.forEach(function(value,key){if(value===fileIndex){processingQueue.splice(key,1);}});doneQueue.push(fileIndex);global_progress[global_progress_index]=100;globalProgress();if(filesDone===(files_count-filesRejected)){afterAll();}
if(result===false){stop_loop=true;}
if(xhr.status<200||xhr.status>299){opts.error(xhr.statusText,file,fileIndex,xhr.status);}};};process();}
function getIndexBySize(size){for(var i=0;i<files_count;i++){if(files[i].size===size){return i;}}
return undefined;}
function rename(name){return opts.rename(name);}
function beforeEach(file){return opts.beforeEach(file);}
function afterAll(){return opts.afterAll();}
function dragEnter(e){clearTimeout(doc_leave_timer);e.preventDefault();opts.dragEnter.call(this,e);}
function dragOver(e){clearTimeout(doc_leave_timer);e.preventDefault();opts.docOver.call(this,e);opts.dragOver.call(this,e);}
function dragLeave(e){clearTimeout(doc_leave_timer);opts.dragLeave.call(this,e);e.stopPropagation();}
function docDrop(e){e.preventDefault();opts.docLeave.call(this,e);return false;}
function docEnter(e){clearTimeout(doc_leave_timer);e.preventDefault();opts.docEnter.call(this,e);return false;}
function docOver(e){clearTimeout(doc_leave_timer);e.preventDefault();opts.docOver.call(this,e);return false;}
function docLeave(e){doc_leave_timer=setTimeout((function(_this){return function(){opts.docLeave.call(_this,e);};})(this),200);}
return this;};function empty(){}
try{if(XMLHttpRequest.prototype.sendAsBinary){return;}
XMLHttpRequest.prototype.sendAsBinary=function(datastr){function byteValue(x){return x.charCodeAt(0)&0xff;}
var ords=Array.prototype.map.call(datastr,byteValue);var ui8a=new Uint8Array(ords);this.send(ui8a.buffer);};}catch(e){}})(jQuery);$(function(){$('#upload-drop').on('click',function(){$('#file').trigger('click');}).filedrop({fallback_id:'file',url:'/files/ajax/upload.php',paramname:'file',error:function(err,file){switch(err){case'BrowserNotSupported':$('#upload-drop').hide();$('#upload-form').addClass('visible');break;case'FileTooLarge':$('.msg-error').show().children('span').text('File is too large');break;case'FileTypeNotAllowed':$('.msg-error').show().children('span').text('Invalid file type');break;default:$('.msg-error').show().children('span').text('Error uploading file');break;}},allowedfiletypes:['image/jpeg','image/jpg','image/png','image/gif'],maxfiles:1,maxfilesize:5,uploadFinished:function(i,file,response,time){if(response=='done')
window.location.replace("?done");else
window.location.replace("?error");},beforeSend:function(file,i,done){done();}});});$(function(){$('pre.bbcode_code_body').each(function(i,e){hljs.highlightBlock(e)});$('body').on('click','.bbcode_spoiler_head',function(e){e.preventDefault();$(this).toggleClass('active');});var $allVideos=$(".bbcode-youtube, .bbcode-vimeo");function resizeVideos(){$allVideos.each(function(){var $el=$(this);$el.removeAttr('height').height($el.width()*0.56);});}
$(window).resize(resizeVideos).resize();});(function(jQuery){var dataKey=jQuery('body').attr('data-key');if(typeof dataKey!=='string'||dataKey==='')return;var TOKEN_NAME='ajax_csrf_token';var TOKEN_VALUE=dataKey;var ALLOWED_HOSTNAMES=['www.crushit.fit','crushit.fit','localhost'];var TOKEN_STRING=TOKEN_NAME+'='+TOKEN_VALUE;jQuery.ajaxPrefilter(function(options){var tempLink=document.createElement("a");tempLink.href=options.url;var hostname=tempLink.hostname||window.location.hostname;if(ALLOWED_HOSTNAMES.indexOf(hostname)>-1){var urlParts=options.url.split('?');var queryString=urlParts[1];if(typeof queryString==='undefined'){queryString=TOKEN_STRING;}else if(queryString.indexOf(TOKEN_NAME)===-1){queryString=TOKEN_STRING+'&'+queryString;}
options.url=urlParts[0]+'?'+queryString;}});})(jQuery);var socket=null;if(typeof io!=='undefined'){socket=io.connect('https://www.hackthis.co.uk:8080/',{secure:true});}
var favcounter=new FavCounter();var counter_chat=0;var counter_notifications=0;$(function(){var username=$('body').attr('data-username');var key=$('body').attr('data-key');var feedTmpl='<tmpl>'+'    <li>'+'      <div class="col span_18">'+'        {{if type == "join"}}'+'            <i class="icon-user"></i><a href="/user/${username}">${username}</a>'+'        {{else type == "friend"}}'+'            <i class="icon-addfriend"></i><a href="/user/${username}">${username}</a> <span class="dark">and</span> <a href="/user/${username_2}">${username_2}</a>'+'        {{else type == "medal"}}'+'            <i class="icon-trophy colour-${uri}"></i><a href="/medals.php#${title.toLowerCase()}">${title}</a> <span class="dark">to</span> <a href="/user/${username}">${username}</a>'+'        {{else type == "comment"}}'+'            <i class="icon-comments"></i><a href="${uri}">${title}</a> <span class="dark">by</span> <a href="/user/${username}">${username}</a>'+'        {{else type == "forum_post"}}'+'            <i class="icon-chat"></i><a href="${uri}">${title}</a> <span class="dark">by</span> <a href="/user/${username}">${username}</a>'+'        {{else type == "favourite"}}'+'            <i class="icon-heart"></i><a href="${uri}">${title}</a> <span class="dark">by</span> <a href="/user/${username}">${username}</a>'+'        {{else type == "article"}}'+'            <i class="icon-books"></i><a href="${uri}">${title}</a> <span class="dark">by</span> <a href="/user/${username}">${username}</a>'+'        {{else type == "news"}}'+'            <i class="icon-article"></i><a href="${uri}">${title}</a> <span class="dark">by</span> <a href="/user/${username}">${username}</a>'+'        {{else type == "level"}}'+'            <i class="icon-good"></i><a href="${uri}">${title}</a> <span class="dark">by</span> <a href="/user/${username}">${username}</a>'+'        {{/if}}'+'        </div>'+'        <div class="col span_6 time right"><time class="short" datetime="${timestamp}"></time></div>'+'    </li>'+'</tmpl>';if(socket){socket.on('feed',function(data){var item=$(feedTmpl).tmpl(data);if($('.sidebar .feed ul').length){item.hide().prependTo($('.sidebar .feed ul')).slideDown();}else{var html=$('<ul>').append(item);$('.sidebar .feed .feed_loading').replaceWith(html);}});}else{$('.sidebar .feed .feed_loading').html('<strong>Feed offline</strong>');}
var lastUpdate=0;var UPDATE_INTERVAL_ACTIVE=10000;var UPDATE_INTERVAL_INACTIVE=30000;(function updateTimes(){uri='/files/ajax/notifications.php';$.post(uri,{last:lastUpdate},function(data){if(data.counts.events>0){$('.nav-extra-events').addClass('alert');$('#event-counter').fadeIn(500).text(data.counts.events);}else{$('.nav-extra-events').removeClass('alert');$('#event-counter').fadeOut(200);}
if(data.counts.pm>0){$('.nav-extra-pm').addClass('alert');$('#pm-counter').fadeIn(500).text(data.counts.pm);}else{$('.nav-extra-pm').removeClass('alert');$('#pm-counter').fadeOut(200);}
counter_notifications=data.counts.events+data.counts.pm;favcounter.set(counter_notifications+counter_chat);},'json');if($(window).data('isInactive')===true){setTimeout(updateTimes,UPDATE_INTERVAL_INACTIVE);}else{setTimeout(updateTimes,UPDATE_INTERVAL_ACTIVE);}})();var notificationsTmpl='<tmpl>'+'{{if seen == 0}}'+'    <li class="new">'+'{{else}}'+'    <li>'+'{{/if}}'+'        <time class="short" datetime="${timestamp}"></time>'+'{{if username}}'+'        <a href="/user/${username}">'+'            <img class="left" width="28" height="28" src="${img}"/>'+'        </a>'+'{{/if}}'+'    {{if type == "friend"}}'+'            {{if status == 1}}'+'                You accepted a friend request from <a href="/user/${username}">${username}<a/>'+'            {{else}}'+'                <a href="/user/${username}">${username}<a/> sent you a friend request'+'                <a href="#" class="addfriend" data-uid="${uid}">Accept</a> | <a href="#" class="removefriend" data-uid="${uid}">Decline</a>'+'            {{/if}}'+'    {{else type == "friend_accepted"}}'+'            <a href="/user/${username}">${username}<a/> accepted your friend request'+'    {{else type == "medal"}}'+'            You have been awarded <a href="/medals.php#${label.toLowerCase()}"><div class="medal medal-${colour}">${label}</div></a><br/>'+'    {{else type == "comment_reply"}}'+'            <a href="/user/${username}">${username}<a/> replied to your comment on <a href="${slug}">${title}</a><br/>'+'    {{else type == "comment_mention"}}'+'            <a href="/user/${username}">${username}<a/> mentioned you in a comment on <a href="${slug}">${title}</a><br/>'+'    {{else type == "forum_post"}}'+'            <a href="/user/${username}">${username}<a/> posted in <a href="${slug}">${title}</a><br/>'+'    {{else type == "forum_mention"}}'+'            <a href="/user/${username}">${username}<a/> mentioned you in <a href="${slug}">${title}</a><br/>'+'    {{else type == "article"}}'+'            Your article has been published <a href="${slug}">${title}</a><br/>'+'    {{else type == "mod_contact"}}'+'            <a href="/user/${username}">${username}</a> replied to your <a href="/contact?view=${ticket}">ticket</a><br/>'+'    {{else type == "mod_report"}}'+'            <a href="/user/${username}">${username}</a> created a new report, <a href="/contact?report=${report}">view report</a><br/>'+'    {{/if}}'+'    </li>'+'</tmpl>';var inboxTmpl='<tmpl>'+'{{if seen == 0}}'+'    <li class="new">'+'{{else}}'+'    <li>'+'{{/if}}'+'        <a class="show-conversation" data-conversation="${pm_id}" href="/inbox/${pm_id}">'+'            <time class="short" datetime="${timestamp}"></time>'+'            {{each(i,user) users}}'+'                ${user.username}{{if users.length-1 != i}},{{/if}}'+'            {{/each}}'+'            <br/>'+'            <span class="dark">{{html message}}</span>'+'        </a>'+'    </li>'+'</tmpl>';var composeForm='<form class="send"><label for="to">To:</label>'+'<input name="to" class="suggest hide-shadow" data-suggest-at="false" data-suggest-max="2" id="to" autocomplete="off"/><br/>'+'<label for="message">Message:</label><br/>'+'<textarea class="hide-shadow"></textarea>'+'<input type="submit" class="button" value="Send"/>'+'<span class="error"></span>';var replyForm='<form class="send">'+'<label for="message">Reply:</label><br/>'+'<textarea class="hide-shadow"></textarea>'+'<input type="submit" class="button" value="Send"/>'+'<span class="error"></span>';var messagesTmpl='<tmpl>'+'{{if seen == 0}}'+'    <li class="new">'+'{{else}}'+'    <li>'+'{{/if}}'+'        <time class="short" datetime="${timestamp}"></time>'+'{{if username}}'+'        <a href="/user/${username}">'+'            <img class="left" width="28" height="28" src="${img}"/>'+'            ${username}'+'        </a><br/>'+'{{else}}'+'        <img class="left" width="28" height="28"/>'+'        <span class="white">You</span><br/>'+'{{/if}}'+'        {{html message}}'+'    </li>'+'</tmpl>';var dropdown=$('#nav-extra-dropdown');var icons=$('.nav-extra').parent();$('.nav-extra').on('click',function(e){e.preventDefault();e.stopPropagation();var parent=$(this).parent();if(dropdown.is(":visible")&&(($(this).hasClass('nav-extra-pm')&&parent.hasClass('active-pm'))||($(this).hasClass('nav-extra-events')&&parent.hasClass('active-events')))){dropdown.slideUp(200);icons.removeClass('active');return false;}
icons.removeClass('active');if($(this).hasClass('nav-extra-pm')){var uri='/files/ajax/inbox.php?list';icons.removeClass('active-events');parent.addClass('active active-pm');}else if($(this).hasClass('nav-extra-events')){var uri='/files/ajax/notifications.php?events';icons.removeClass('active-pm');$(this).removeClass('alert');$('#event-counter').fadeOut(200);parent.addClass('active active-events');}else{return false;}
$.getJSON(uri,function(data){var items=data.items;if(items.length||(items.items&&items.items.length)){if(parent.hasClass('active-events')){var html=$('<ul>');var count=data.friends.length-1;$.each(data.friends,function(index){tmpli=$(notificationsTmpl).tmpl(this);if(count==index){tmpli.addClass('last-request');}
html.append(tmpli);});var items=$(notificationsTmpl).tmpl(items.items);var more=$("<li>",{class:"more"});$('<a>',{text:"View More",href:"/alerts.php"}).appendTo(more);html.append(items).append(more);}else{var items=$(inboxTmpl).tmpl(items);var messagesHTML=$('<div>',{class:"messages"});$('<a>',{text:"New Message",class:"toggle-compose more",href:"/inbox/compose"}).appendTo(messagesHTML);var list=$('<ul>').append(items);list.appendTo(messagesHTML);$('<a>',{text:"Full View",class:"more",href:"/inbox/"}).appendTo(messagesHTML);var extraHTML=$('<div>',{class:"extra"});html=$('<div>',{class:"message-container"}).append(messagesHTML);html.append(extraHTML)}}else{if(parent.hasClass('active-events'))
var html='<div class="center empty"><i class="icon-globe icon-4x"></i>No notifications available</div>';else{var messagesHTML=$('<div>',{class:"messages"});$('<a>',{text:"New Message",class:"toggle-compose more",href:"/inbox/compose"}).appendTo(messagesHTML);var list=$('<div class="center empty"><i class="icon-envelope-alt icon-4x"></i>No messages available</div>');list.appendTo(messagesHTML);$('<a>',{text:"Full View",class:"more",href:"/inbox/"}).appendTo(messagesHTML);var extraHTML=$('<div>',{class:"extra"});html=$('<div>',{class:"message-container"}).append(messagesHTML);html.append(extraHTML)}}
dropdown.html(html).slideDown(200);});bindCloseNotifications();});$('#global-nav').on('click','.addfriend, .removefriend',function(e){e.preventDefault();var $this=$(this);if($this.hasClass('addfriend'))
var uri='/files/ajax/user.php?action=friend.add&uid=';else
var uri='/files/ajax/user.php?action=friend.remove&uid=';uri+=$this.attr('data-uid');uri+="&token="+$('body').attr('data-key');$.getJSON(uri,function(data){if(data.status)
$this.closest('li').slideUp();});}).on('click','.toggle-compose',function(e){e.preventDefault();e.stopPropagation();var container=$('#global-nav .message-container');if(container.hasClass('show-extra')){container.removeClass('show-extra');}else{var composeHTML=container.children('.extra');composeHTML.html('');$('<a>',{text:"Back to Inbox",class:"toggle-compose more",href:"/inbox"}).appendTo(composeHTML);composeHTML.append(composeForm);$('<a>',{text:"Full View",class:"more full-view-via-storage",href:"/inbox/compose"}).appendTo(composeHTML);container.addClass('show-extra');$('#nav-extra-dropdown .suggest').autosuggest();}}).on('click','.show-conversation',function(e){e.preventDefault();var $this=$(this);var id=$this.attr('data-conversation');var uri='/files/ajax/inbox.php?view&id='+id;$.getJSON(uri,function(data){data=data.items;if(data.length){var container=$('#global-nav .message-container');items=$('<ul>',{class:'scroll'}).append($(messagesTmpl).tmpl(data));items.append($('<li>').append(replyForm));items.find('form').attr('data-conversation',id);var messagesHTML=container.children('.extra');messagesHTML.html('');$('<a>',{text:"Back to Inbox",class:"toggle-compose more",href:"/inbox"}).appendTo(messagesHTML);messagesHTML.append(items);$('<a>',{text:"Full View",class:"more full-view-via-storage",href:"/inbox/"+id}).appendTo(messagesHTML);container.addClass('show-extra');$('#global-nav .scroll').mCustomScrollbar();if(container.find('.new').length){$('#global-nav .scroll').mCustomScrollbar("scrollTo","li.new:first");}else{$('#global-nav .scroll').mCustomScrollbar("scrollTo","li:nth-last-child(2)");}
$this.parent().removeClass('new');}});}).on('click','form.send input.button',function(e){e.preventDefault();e.stopPropagation();var data={};$form=$(this).closest('form');$error=$form.find('span.error');data.body=$form.find('textarea').val();$error.text('');if($form.find('#to').length){data.to=$form.find('#to').val();if(!data.to){$error.text("Missing recipient");return;}}else if($form.attr('data-conversation')){data.pm_id=$form.attr('data-conversation');}else{return;}
if(!data.body){$error.text("Missing body");return;}
var uri='/files/ajax/inbox.php?send';$.post(uri,data,function(data){if(data.status){if(data.message){data.seen=true;data.img="";var $msg=$(messagesTmpl).tmpl(data);$msg.hide();$form.closest('li').before($msg);$msg.slideDown(function(){$form.closest('.scroll').mCustomScrollbar("scrollTo","bottom");});$form.find('textarea').val('');var pm_id=$form.attr('data-conversation');$item=$('#nav-extra-dropdown .messages ul li > a[data-conversation="'+pm_id+'"]').parent();$item.detach();$item.find('span.dark').html('<i class="icon-reply"></i> '+data.message);var date=new Date();$item.find('time').attr('datetime',date.toISOString()).text('secs');$item.prependTo($('#nav-extra-dropdown .messages ul'));}else{$sent=$('<div class="center empty fill"><i class="icon-ok-sign icon-4x"></i>Message Sent</div>').hide();$form.replaceWith($sent);$sent.fadeIn();}}else
$error.text("Error sending message");},'json');}).on('click','.full-view-via-storage',function(e){e.stopPropagation();if(window.localStorage){if($('#to').length)
window.localStorage.recipients=$('#to')[0].value;window.localStorage.content=$('form.send textarea')[0].value;}});$('body').on('click','.messages-new',function(e){e.preventDefault();e.stopPropagation();var to=$(this).attr('data-to');var composeHTML=$('<div>',{class:"compose"});composeHTML.append(composeForm);$('<a>',{text:"Full View",class:"more",href:"/inbox/compose?to="+to}).appendTo(composeHTML);dropdown.html(composeHTML).slideDown(200);$('#nav-extra-dropdown .suggest').val(to).autosuggest();$('#nav-extra-dropdown textarea').focus();icons.removeClass('active active-events active-pm');bindCloseNotifications();});function bindCloseNotifications(){$(document).bind('click.extra-hide',function(e){if($(e.target).closest('#nav-extra-dropdown').length!=0&&$(e.target).not('.nav-extra'))return true;hideNotifications();});}
function hideNotifications(){dropdown.slideUp(200);icons.removeClass('active active-events active-pm');$(document).unbind('click.extra-hide');}});$.fn.autosuggest=function(){this.each(function(){$self=$(this);$self.keyup(function(event){var $this=$(this);var auto=$this.attr('data-suggest-at')==='false'?false:true;var caret=$this.getCursorPosition().end;var val=this.value+' ';var word=/\S+$/.exec(val.slice(0,val.indexOf(' ',caret)));if(!word){$this.siblings('.autosuggest').remove();return;}
word=word[0];if(auto){if(word.substr(0,1)!=='@'){$this.siblings('.autosuggest').remove();return;}
word=word.substr(1);}
var max=$this.attr('data-suggest-max')?$this.attr('data-suggest-max'):5;if(word.length<3)
return false;$.get('/files/ajax/autosuggest.php',{user:word,max:max},function(data){$this.siblings('.autosuggest').remove();var list=$('<ul>',{class:'autosuggest'});if(!auto){list.addClass('autosuggest-alt');}
if(data.status==false)
return;for(var i=0;i<data.users.length;++i){user=data.users[i];var icon=$('<i>',{class:'icon-addfriend'});var link=$('<a>',{text:user.username,href:'#'+user.username});if(user.friends==1)
link.append(icon);$('<li>').append(link).appendTo(list);}
$this.after(list);},'json');$(document).bind('click.suggest-hide',function(e){if($(e.target).closest('.autosuggest').length!=0||$(e.target).hasClass('suggest'))return true;$('.autosuggest').remove();$(document).unbind('click.suggest-hide');});});$self.parent().on('click','.autosuggest a',function(e){var $this=$(this);e.preventDefault();e.stopPropagation();var $self=$this.closest('.autosuggest').prev();var auto=$self.attr('data-suggest-at')==='false'?false:true;$this.closest('.autosuggest').remove();var insert=this.hash.slice(1);if(!auto)insert+=",";tmp=$self.val()+' ';var caret=$self.getCursorPosition().end;var wordEnd=tmp.indexOf(' ',caret);var word=/\S+$/.exec(tmp.slice(0,wordEnd));if(auto)
var start=tmp.substr(0,wordEnd-word[0].length+1);else
var start=tmp.substr(0,wordEnd-word[0].length);var end=tmp.substr(wordEnd);var tmp=start+insert+end;$self.val(tmp).focus().setCursorPosition(start.length+insert.length+1);});});};function searchsuggest(){var $this=$('.nav-search input'),value=$this[0].value;if(value.length<3){$this.parent().siblings('.searchsuggest').remove();return false;}
$.get('/files/ajax/autosuggest.php',{search:value},function(data){if(data.status){var suggest=$('<div>',{class:'searchsuggest'});if(data.data.users){var users=data.data.users;title=$('<h3>',{text:'Users'});suggest.append(title);len=users.length<5?users.length:5;for(var i=0;i<len;++i){link=$('<a>',{text:users[i].username,href:'/user/'+users[i].username});suggest.append(link);}}
if(data.data.articles){var articles=data.data.articles;title=$('<h3>',{text:'Articles'});suggest.append(title);len=articles.length<5?articles.length:5;for(var i=0;i<len;++i){link=$('<a>',{html:articles[i].title,href:'/articles/'+articles[i].slug});suggest.append(link);}}
if(data.data.forum){var forum=data.data.forum;title=$('<h3>',{text:'Forum'});suggest.append(title);len=forum.length<5?forum.length:5;for(var i=0;i<len;++i){link=$('<a>',{html:forum[i].title,href:'/forum/'+forum[i].slug});suggest.append(link);}}
$this.parent().siblings('.searchsuggest').remove();$this.parent().after(suggest);}else{$this.parent().siblings('.searchsuggest').remove();}},'json');$(document).bind('click.search-hide',function(e){if($(e.target).closest('.searchsuggest').length!=0||$(e.target).hasClass('suggest'))return true;$('.searchsuggest').remove();$(document).unbind('click.search-hide');});}
$(function(){var timer=null;$('.suggest').autosuggest();$('.nav-search input').keyup(function(event){if(timer){clearTimeout(timer);}
timer=setTimeout(searchsuggest,200);});});